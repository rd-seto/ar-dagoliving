<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test AR #3</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.1.7/aframe/build/aframe-ar.js"></script>
  <style>
    /* Add basic style for info display */
    .info-ui {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      z-index: 10;
    }
    .found {
      background-color: rgba(0, 128, 0, 0.6);
    }
    .lost {
      background-color: rgba(255, 0, 0, 0.6);
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <!-- AR Scene -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <!-- Marker for tracking -->
    <a-marker type="pattern" url="https://raw.githubusercontent.com/rd-seto/ar-dagoliving/main/pattern-hiro.patt" emitevents="true" id="marker">
      <!-- Plane to display the image -->
      <a-plane id="imagePlane" position="4 0 0" rotation="-90 0 0" width="4" height="2.25" material="shader: flat; scale: 2 2 2"></a-plane>
    </a-marker>

    <!-- Camera to view the scene -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Information UI Element -->
  <div class="info-ui lost" id="uiobj">Waiting for marker...</div>

  <!-- Script to refresh every 5 seconds -->
  <script>
    const imagePlane = document.getElementById("imagePlane");
    const marker = document.getElementById("marker");
    const infoui = document.getElementById("uiobj");

    // Correct URL to the image
    const imageUrl = "https://raw.githubusercontent.com/rd-seto/ar-dagoliving/main/capture.jpg"; 
    let isAnimationRunning = false; // To prevent multiple animations

    // Function to display information about the marker
    function markerInfo(marker, evt, infoui) {
      let posx = marker.object3D.position.x;
      let posy = marker.object3D.position.y;
      let posz = marker.object3D.position.z;

      let markerID = marker.getAttribute("preset") ? marker.getAttribute("preset") : marker.getAttribute("type") == "barcode" ? marker.getAttribute("type") + " " + marker.getAttribute("value") : marker.getAttribute("type");
      let message = "Marker " + markerID + " at x: " + posx + ", y: " + posy + ", z: " + posz;

      if (evt) {
        infoui.classList.remove("lost");
        infoui.classList.add("found");
        message = "Found: " + message;
      } else {
        infoui.classList.remove("found");
        infoui.classList.add("lost");
        message = "Lost: " + message;
      }

      infoui.innerHTML = message;
    }

    // Detecting marker found and lost
    marker.addEventListener("markerFound", (e) => {
      markerInfo(marker, true, infoui);
      if (!isAnimationRunning) {
        animatePosition(0, 4, 0, 1000); // Animates from (0, 0, 0) to (4, 0, 0) in 1 second
      }
    });

    marker.addEventListener("markerLost", (e) => {
      markerInfo(marker, false, infoui);
      if (!isAnimationRunning) {
        animatePosition(4, 0, 0, 1000); // Animates from (4, 0, 0) to (0, 0, 0) in 1 second
      }
    });

    function animatePosition(startX, endX, endY, duration) {
      isAnimationRunning = true;
      const startTime = performance.now();
      const startY = 0;

      function updatePosition(currentTime) {
        const elapsedTime = currentTime - startTime;
        if (elapsedTime < duration) {
          const newX = startX + (endX - startX) * (elapsedTime / duration);
          const newY = startY + (endY - startY) * (elapsedTime / duration);
          imagePlane.setAttribute("position", `${newX} ${newY} 0`);
          requestAnimationFrame(updatePosition);
        } else {
          imagePlane.setAttribute("position", `${endX} ${endY} 0`);
          isAnimationRunning = false;
        }
      }

      requestAnimationFrame(updatePosition);
    }

    // Function to update the image source
    function updateImageSource() {
      const uniqueParam = Date.now(); // Generate a unique parameter
      const newImageUrl = `${imageUrl}?v=${uniqueParam}`;
      imagePlane.setAttribute("material", "src", newImageUrl);
    }

    // Initial image update
    updateImageSource();
    // Check for image update every 5 seconds
    setInterval(updateImageSource, 5000);
  </script>
</body>
</html>
